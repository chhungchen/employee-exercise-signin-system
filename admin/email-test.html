<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒµä»¶æœå‹™æ¸¬è©¦ - å“¡å·¥é‹å‹•ç°½åˆ°ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
            border-left: 4px solid #6c757d;
        }
        .status-card.success {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .status-card.warning {
            border-left-color: #ffc107;
            background-color: #fffcf0;
        }
        .status-card.error {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log-entry {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-entry.success {
            color: #155724;
            background-color: #d4edda;
        }
        .log-entry.error {
            color: #721c24;
            background-color: #f8d7da;
        }
        .log-entry.info {
            color: #0c5460;
            background-color: #d1ecf1;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        .service-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-weight: 500;
        }
        .service-status.active {
            background-color: #d4edda;
            color: #155724;
        }
        .service-status.failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .service-status.available {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-envelope-open-text text-primary"></i>
                    éƒµä»¶æœå‹™æ¸¬è©¦ä¸­å¿ƒ
                </h1>
            </div>
        </div>

        <!-- æœå‹™ç‹€æ…‹ç¸½è¦½ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card" id="statusCard">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-server"></i>
                            éƒµä»¶æœå‹™ç‹€æ…‹
                            <button class="btn btn-sm btn-outline-primary float-end" onclick="refreshStatus()">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i>
                                åˆ·æ–°ç‹€æ…‹
                            </button>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="serviceStatus">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- éƒµä»¶æ¸¬è©¦è¡¨å–® -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-paper-plane"></i>
                            éƒµä»¶ç™¼é€æ¸¬è©¦
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="emailTestForm">
                            <div class="mb-3">
                                <label for="testEmail" class="form-label">æ”¶ä»¶äººéƒµç®±</label>
                                <input type="email" class="form-control" id="testEmail" required
                                       placeholder="ä¾‹å¦‚ï¼štest@example.com">
                            </div>
                            <div class="mb-3">
                                <label for="testType" class="form-label">æ¸¬è©¦é¡å‹</label>
                                <select class="form-select" id="testType">
                                    <option value="simple">ç°¡å–®æ¸¬è©¦éƒµä»¶</option>
                                    <option value="report">é‹å‹•å ±å‘Šæ¸¬è©¦</option>
                                    <option value="notification">ç³»çµ±é€šçŸ¥æ¸¬è©¦</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="testSubject" class="form-label">è‡ªå®šç¾©ä¸»æ—¨ï¼ˆå¯é¸ï¼‰</label>
                                <input type="text" class="form-control" id="testSubject"
                                       placeholder="é è¨­æœƒæ ¹æ“šæ¸¬è©¦é¡å‹ç”Ÿæˆ">
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="sendTestBtn">
                                <i class="fas fa-paper-plane"></i>
                                ç™¼é€æ¸¬è©¦éƒµä»¶
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line"></i>
                            å¥åº·æª¢æŸ¥
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="runHealthCheck()">
                                <i class="fas fa-heartbeat"></i>
                                åŸ·è¡Œå®Œæ•´å¥åº·æª¢æŸ¥
                            </button>
                            <button class="btn btn-warning" onclick="testAllProviders()">
                                <i class="fas fa-network-wired"></i>
                                æ¸¬è©¦æ‰€æœ‰éƒµä»¶æä¾›è€…
                            </button>
                            <button class="btn btn-secondary" onclick="viewServiceLogs()">
                                <i class="fas fa-file-alt"></i>
                                æŸ¥çœ‹æœå‹™æ—¥èªŒ
                            </button>
                        </div>

                        <hr>

                        <h6>Render éƒ¨ç½²æª¢æŸ¥</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="checkRenderConfig()">
                                <i class="fas fa-cog"></i>
                                æª¢æŸ¥ Render ç’°å¢ƒè®Šæ•¸
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="validateResendAPI()">
                                <i class="fas fa-key"></i>
                                é©—è­‰ Resend API é‡‘é‘°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŸ·è¡Œæ—¥èªŒ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal"></i>
                            åŸ·è¡Œæ—¥èªŒ
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                            <i class="fas fa-trash-alt"></i>
                            æ¸…é™¤æ—¥èªŒ
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="log-container" id="logContainer">
                            <div class="log-entry info">
                                <i class="fas fa-info-circle"></i>
                                [åˆå§‹åŒ–] éƒµä»¶æ¸¬è©¦ç³»çµ±å·²å°±ç·’ï¼Œè«‹é»æ“Šã€Œåˆ·æ–°ç‹€æ…‹ã€æª¢æŸ¥æœå‹™ç‹€æ…‹
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨­å®šæŒ‡å—æ¨¡æ…‹æ¡† -->
        <div class="modal fade" id="configModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-cog"></i>
                            Render ç’°å¢ƒè®Šæ•¸é…ç½®æŒ‡å—
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="configModalBody">
                        <!-- å‹•æ…‹è¼‰å…¥é…ç½®æŒ‡å—å…§å®¹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let logCounter = 0;

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            addLog('[åˆå§‹åŒ–] éƒµä»¶æ¸¬è©¦ç³»çµ±å·²å°±ç·’ï¼Œæ­£åœ¨æª¢æŸ¥èªè­‰ç‹€æ…‹...', 'info');

            // æª¢æŸ¥èªè­‰ç‹€æ…‹
            try {
                const token = await getAuthToken();
                if (token) {
                    addLog('âœ… èªè­‰é©—è­‰æˆåŠŸï¼Œé–‹å§‹è¼‰å…¥æœå‹™ç‹€æ…‹...', 'success');
                    refreshStatus();
                } else {
                    addLog('âŒ èªè­‰é©—è­‰å¤±æ•—ï¼Œè«‹å…ˆç™»å…¥ç®¡ç†å“¡ç³»çµ±', 'error');
                }
            } catch (error) {
                addLog(`âŒ åˆå§‹åŒ–éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }

            // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('emailTestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                sendTestEmail();
            });
        });

        // æ·»åŠ æ—¥èªŒæ¢ç›®
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleString('zh-TW');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;

            let icon;
            switch(type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    break;
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    break;
                default:
                    icon = 'fas fa-info-circle';
            }

            logEntry.innerHTML = `<i class="${icon}"></i> [${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            logCounter++;
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦ç²å– Token
        async function getAuthToken() {
            try {
                // æª¢æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ token
                let token = localStorage.getItem('adminToken');
                if (token) {
                    // é©—è­‰ token æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                    const verifyResponse = await fetch('/api/admin/verify', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (verifyResponse.ok) {
                        return token;
                    }
                }

                // å¦‚æœæ²’æœ‰æœ‰æ•ˆ tokenï¼Œå˜—è©¦ä½¿ç”¨ç®¡ç†å“¡é é¢çš„èªè­‰
                const adminLoginResponse = await fetch('/api/admin/verify', {
                    credentials: 'include' // åŒ…å« cookies
                });

                if (adminLoginResponse.ok) {
                    const adminData = await adminLoginResponse.json();
                    if (adminData.token) {
                        localStorage.setItem('adminToken', adminData.token);
                        return adminData.token;
                    }
                }

                // å¦‚æœéƒ½å¤±æ•—ï¼Œé‡æ–°å°å‘åˆ°ç™»å…¥é é¢
                addLog('âŒ éœ€è¦ç®¡ç†å“¡ç™»å…¥ï¼Œæ­£åœ¨é‡æ–°å°å‘...', 'error');
                setTimeout(() => {
                    window.location.href = '/admin';
                }, 2000);
                return null;

            } catch (error) {
                addLog(`âŒ èªè­‰æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
                return null;
            }
        }

        // åˆ·æ–°æœå‹™ç‹€æ…‹
        async function refreshStatus() {
            const refreshIcon = document.getElementById('refreshIcon');
            const statusCard = document.getElementById('statusCard');
            const serviceStatus = document.getElementById('serviceStatus');

            refreshIcon.classList.add('fa-spin');
            addLog('æ­£åœ¨æª¢æŸ¥éƒµä»¶æœå‹™ç‹€æ…‹...', 'info');

            try {
                // ç²å–èªè­‰ Token
                const token = await getAuthToken();
                if (!token) {
                    throw new Error('éœ€è¦æä¾›èªè­‰Token');
                }

                const response = await fetch('/api/admin/email-status', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    displayServiceStatus(data);
                    statusCard.className = 'card status-card success';
                    addLog('âœ… æœå‹™ç‹€æ…‹æª¢æŸ¥å®Œæˆ', 'success');
                } else {
                    if (response.status === 401) {
                        // Token éæœŸï¼Œæ¸…é™¤ä¸¦é‡æ–°å°å‘
                        localStorage.removeItem('adminToken');
                        throw new Error('èªè­‰å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    }
                    throw new Error(data.message || 'ç‹€æ…‹æª¢æŸ¥å¤±æ•—');
                }
            } catch (error) {
                serviceStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        ç„¡æ³•ç²å–æœå‹™ç‹€æ…‹: ${error.message}
                        ${error.message.includes('èªè­‰') ? '<br><small>å°‡åœ¨ 3 ç§’å¾Œé‡æ–°å°å‘åˆ°ç®¡ç†å“¡ç™»å…¥é é¢...</small>' : ''}
                    </div>
                `;
                statusCard.className = 'card status-card error';
                addLog(`âŒ æœå‹™ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');

                if (error.message.includes('èªè­‰') || error.message.includes('ç™»å…¥')) {
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 3000);
                }
            } finally {
                refreshIcon.classList.remove('fa-spin');
            }
        }

        // é¡¯ç¤ºæœå‹™ç‹€æ…‹
        function displayServiceStatus(data) {
            const serviceStatus = document.getElementById('serviceStatus');

            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>æœå‹™æ¦‚æ³</h6>
                        <p><strong>åˆå§‹åŒ–ç‹€æ…‹ï¼š</strong>
                            ${data.initialized ? '<span class="badge bg-success">å·²åˆå§‹åŒ–</span>' : '<span class="badge bg-danger">æœªåˆå§‹åŒ–</span>'}
                        </p>
                        <p><strong>ç•¶å‰æä¾›è€…ï¼š</strong> ${data.currentProvider || 'ç„¡'}</p>
                        <p><strong>å¯ç”¨æä¾›è€…ï¼š</strong> ${data.availableProviders} å€‹</p>
                        <p><strong>å¤±æ•—æä¾›è€…ï¼š</strong> ${data.failedProviders.length} å€‹</p>
                    </div>
                    <div class="col-md-6">
                        <h6>æä¾›è€…è©³æƒ…</h6>
                        <div class="provider-list">
            `;

            if (data.providerDetails && data.providerDetails.length > 0) {
                data.providerDetails.forEach(provider => {
                    const statusClass = provider.status === 'active' ? 'active' :
                                       provider.status === 'failed' ? 'failed' : 'available';

                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>${provider.name}</span>
                            <span class="service-status ${statusClass}">${provider.status}</span>
                        </div>
                    `;
                });
            } else {
                html += '<p class="text-muted">ç„¡å¯ç”¨æä¾›è€…</p>';
            }

            html += `
                        </div>
                    </div>
                </div>
            `;

            // å¦‚æœæ˜¯ Render ç’°å¢ƒä¸”æ²’æœ‰å¯ç”¨çš„ HTTP API æœå‹™ï¼Œé¡¯ç¤ºé…ç½®æç¤º
            if (data.isRender && data.availableProviders === 0) {
                html += `
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-exclamation-triangle"></i> Render ç’°å¢ƒé…ç½®æé†’</h6>
                        <p>æª¢æ¸¬åˆ°æ‚¨åœ¨ Render ç’°å¢ƒä¸­ï¼Œä½†æ²’æœ‰é…ç½® HTTP API éƒµä»¶æœå‹™ã€‚è«‹ï¼š</p>
                        <ol>
                            <li>è¨»å†Š <a href="https://resend.com/" target="_blank">Resend</a> å¸³è™Ÿ</li>
                            <li>åœ¨ Render Dashboard è¨­å®š <code>RESEND_API_KEY</code> ç’°å¢ƒè®Šæ•¸</li>
                            <li>è¨­å®š <code>EMAIL_FROM</code> ç‚ºæ‚¨é©—è­‰çš„ç™¼é€è€…åœ°å€</li>
                        </ol>
                        <button class="btn btn-sm btn-info" onclick="showConfigGuide()">
                            <i class="fas fa-book"></i> æŸ¥çœ‹è©³ç´°é…ç½®æŒ‡å—
                        </button>
                    </div>
                `;
            }

            serviceStatus.innerHTML = html;
        }

        // ç™¼é€æ¸¬è©¦éƒµä»¶
        async function sendTestEmail() {
            const sendBtn = document.getElementById('sendTestBtn');
            const email = document.getElementById('testEmail').value;
            const type = document.getElementById('testType').value;
            const subject = document.getElementById('testSubject').value;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ç™¼é€ä¸­...';

            addLog(`ğŸ“§ é–‹å§‹ç™¼é€æ¸¬è©¦éƒµä»¶åˆ° ${email}...`, 'info');

            try {
                // ç²å–èªè­‰ Token
                const token = await getAuthToken();
                if (!token) {
                    throw new Error('éœ€è¦æä¾›èªè­‰Token');
                }

                const response = await fetch('/api/admin/test-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: email,
                        testType: type,
                        subject: subject
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.success && data.data) {
                        addLog(`âœ… éƒµä»¶ç™¼é€æˆåŠŸï¼`, 'success');
                        addLog(`ğŸ“§ æ”¶ä»¶äºº: ${data.data.recipient}`, 'info');
                        addLog(`ğŸ“¨ è¨Šæ¯ ID: ${data.data.messageId || 'N/A'}`, 'info');
                        addLog(`ğŸ”— ä½¿ç”¨æä¾›è€…: ${data.data.provider || 'N/A'}`, 'info');
                        addLog(`ğŸ“… ç™¼é€æ™‚é–“: ${new Date(data.data.sentAt).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}`, 'info');
                    } else {
                        addLog(`âš ï¸ éƒµä»¶ç™¼é€å›æ‡‰ç•°å¸¸: ${data.message || 'æœªçŸ¥ç‹€æ…‹'}`, 'warning');
                    }
                } else {
                    if (response.status === 401) {
                        localStorage.removeItem('adminToken');
                        throw new Error('èªè­‰å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    }
                    throw new Error(data.message || 'éƒµä»¶ç™¼é€å¤±æ•—');
                }
            } catch (error) {
                addLog(`âŒ éƒµä»¶ç™¼é€å¤±æ•—: ${error.message}`, 'error');
                if (error.message.includes('èªè­‰') || error.message.includes('ç™»å…¥')) {
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 3000);
                }
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ç™¼é€æ¸¬è©¦éƒµä»¶';
            }
        }

        // åŸ·è¡Œå¥åº·æª¢æŸ¥
        async function runHealthCheck() {
            addLog('ğŸ” é–‹å§‹åŸ·è¡Œå®Œæ•´å¥åº·æª¢æŸ¥...', 'info');

            try {
                const response = await fetch('/api/email/health-check');
                const data = await response.json();

                if (response.ok) {
                    addLog('âœ… å¥åº·æª¢æŸ¥å®Œæˆ', 'success');

                    // é¡¯ç¤ºç’°å¢ƒè³‡è¨Š
                    if (data.environment) {
                        addLog(`ğŸŒ å¹³å°ç’°å¢ƒ: ${data.environment.platform}`, 'info');
                        addLog(`âš™ï¸ åŸ·è¡Œç’°å¢ƒ: ${data.environment.nodeEnv}`, 'info');
                    }

                    // é¡¯ç¤ºå¥åº·ç‹€æ…‹
                    if (data.health) {
                        const healthIcon = data.health.status === 'healthy' ? 'ğŸŸ¢' :
                                         data.health.status === 'warning' ? 'ğŸŸ¡' : 'ğŸ”´';
                        addLog(`${healthIcon} ç³»çµ±å¥åº·åº¦: ${data.health.status} (${data.health.score}/100)`,
                               data.health.status === 'healthy' ? 'success' : 'warning');
                        addLog(`ğŸ’¬ ${data.health.message}`, 'info');
                    }

                    // é¡¯ç¤ºæä¾›è€…ç‹€æ…‹
                    if (data.providers) {
                        addLog('ğŸ“‹ éƒµä»¶æä¾›è€…ç‹€æ…‹:', 'info');
                        Object.entries(data.providers).forEach(([name, provider]) => {
                            const status = provider.status === 'ready' ? 'âœ…' :
                                         provider.status === 'not_configured' ? 'âš ï¸' :
                                         provider.status === 'blocked_by_platform' ? 'ğŸš«' : 'âŒ';
                            addLog(`  ${status} ${provider.name}: ${provider.status}`,
                                   provider.status === 'ready' ? 'success' : 'info');
                        });
                    }

                    // é¡¯ç¤ºå»ºè­°
                    if (data.recommendations && data.recommendations.length > 0) {
                        addLog('ğŸ’¡ ç³»çµ±å»ºè­°:', 'info');
                        data.recommendations.forEach(rec => {
                            const priority = rec.priority === 'high' ? 'ğŸ”¥' : 'ğŸ’¡';
                            addLog(`  ${priority} ${rec.message}`, 'info');
                        });
                    }

                } else {
                    throw new Error(data.message || 'å¥åº·æª¢æŸ¥å¤±æ•—');
                }
            } catch (error) {
                addLog(`âŒ å¥åº·æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸¬è©¦æ‰€æœ‰æä¾›è€…
        async function testAllProviders() {
            addLog('ğŸ”„ é–‹å§‹æ¸¬è©¦æ‰€æœ‰éƒµä»¶æä¾›è€…...', 'info');

            try {
                // ç²å–èªè­‰ Token
                const token = await getAuthToken();
                if (!token) {
                    throw new Error('éœ€è¦æä¾›èªè­‰Token');
                }

                const response = await fetch('/api/admin/test-all-providers', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('âœ… æä¾›è€…æ¸¬è©¦å®Œæˆ', 'success');

                    if (data.results && Array.isArray(data.results)) {
                        data.results.forEach(result => {
                            const status = result.success ? 'âœ…' : 'âŒ';
                            addLog(`${status} ${result.provider}: ${result.message} (${result.responseTime}ms)`,
                                   result.success ? 'success' : 'error');
                        });

                        // é¡¯ç¤ºç¸½çµ
                        const summary = data.summary;
                        addLog(`ğŸ“Š æ¸¬è©¦ç¸½çµ: ${summary.successfulTests}/${summary.availableProviders} å€‹æä¾›è€…å¯ç”¨`, 'info');
                    }
                } else {
                    if (response.status === 401) {
                        localStorage.removeItem('adminToken');
                        throw new Error('èªè­‰å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    }
                    throw new Error(data.message || 'æä¾›è€…æ¸¬è©¦å¤±æ•—');
                }
            } catch (error) {
                addLog(`âŒ æä¾›è€…æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                if (error.message.includes('èªè­‰') || error.message.includes('ç™»å…¥')) {
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 3000);
                }
            }
        }

        // æª¢æŸ¥ Render é…ç½®
        async function checkRenderConfig() {
            addLog('ğŸ” æª¢æŸ¥ Render ç’°å¢ƒè®Šæ•¸é…ç½®...', 'info');

            try {
                // ç²å–èªè­‰ Token
                const token = await getAuthToken();
                if (!token) {
                    throw new Error('éœ€è¦æä¾›èªè­‰Token');
                }

                const response = await fetch('/api/admin/check-render-config', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('âœ… Render é…ç½®æª¢æŸ¥å®Œæˆ', 'success');

                    if (data.config) {
                        addLog(`ğŸ“ æª¢æ¸¬åˆ°å¹³å°: ${data.config.platform}`, 'info');

                        // é¡¯ç¤ºå¿…éœ€è®Šæ•¸ç‹€æ…‹
                        if (data.config.environment.requiredVariables) {
                            data.config.environment.requiredVariables.forEach(v => {
                                const status = v.configured ? 'âœ…' : 'âŒ';
                                addLog(`${status} ${v.name}: ${v.configured ? 'å·²é…ç½®' : 'æœªé…ç½®'}`, v.configured ? 'success' : 'error');
                            });
                        }

                        // é¡¯ç¤ºå»ºè­°
                        if (data.config.recommendations && data.config.recommendations.length > 0) {
                            data.config.recommendations.forEach(rec => {
                                const priority = rec.priority === 'critical' ? 'ğŸš¨' : rec.priority === 'high' ? 'âš ï¸' : 'ğŸ’¡';
                                addLog(`${priority} ${rec.message}`, rec.priority === 'critical' ? 'error' : 'info');
                            });
                        }
                    }
                } else {
                    if (response.status === 401) {
                        localStorage.removeItem('adminToken');
                        throw new Error('èªè­‰å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    }
                    throw new Error(data.message || 'Render é…ç½®æª¢æŸ¥å¤±æ•—');
                }
            } catch (error) {
                addLog(`âŒ Render é…ç½®æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
                if (error.message.includes('èªè­‰') || error.message.includes('ç™»å…¥')) {
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 3000);
                }
            }
        }

        // é©—è­‰ Resend API
        async function validateResendAPI() {
            addLog('ğŸ”‘ é©—è­‰ Resend API é‡‘é‘°...', 'info');

            try {
                // ç²å–èªè­‰ Token
                const token = await getAuthToken();
                if (!token) {
                    throw new Error('éœ€è¦æä¾›èªè­‰Token');
                }

                const response = await fetch('/api/admin/validate-resend', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.success) {
                        addLog('âœ… Resend API é‡‘é‘°é©—è­‰æˆåŠŸ', 'success');
                        addLog(`ğŸ“‹ é‡‘é‘°é è¦½: ${data.keyPreview}`, 'info');
                        if (data.note) {
                            addLog(`ğŸ’¡ ${data.note}`, 'info');
                        }
                    } else {
                        addLog('âŒ Resend API é‡‘é‘°é©—è­‰å¤±æ•—', 'error');
                        addLog(`   ${data.message}`, 'error');
                        if (data.keyPreview) {
                            addLog(`ğŸ“‹ é‡‘é‘°é è¦½: ${data.keyPreview}`, 'info');
                        }
                    }
                } else {
                    if (response.status === 401) {
                        localStorage.removeItem('adminToken');
                        throw new Error('èªè­‰å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    }
                    throw new Error(data.message || 'Resend API é©—è­‰å¤±æ•—');
                }
            } catch (error) {
                addLog(`âŒ Resend API é©—è­‰å¤±æ•—: ${error.message}`, 'error');
                if (error.message.includes('èªè­‰') || error.message.includes('ç™»å…¥')) {
                    setTimeout(() => {
                        window.location.href = '/admin';
                    }, 3000);
                }
            }
        }

        // æŸ¥çœ‹æœå‹™æ—¥èªŒ
        function viewServiceLogs() {
            addLog('æœå‹™æ—¥èªŒåŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
            // TODO: å¯¦ä½œæœå‹™æ—¥èªŒæŸ¥çœ‹åŠŸèƒ½
        }

        // é¡¯ç¤ºé…ç½®æŒ‡å—
        function showConfigGuide() {
            const modal = new bootstrap.Modal(document.getElementById('configModal'));
            const modalBody = document.getElementById('configModalBody');

            modalBody.innerHTML = `
                <h6>1. è¨»å†Š Resend å¸³è™Ÿ</h6>
                <p>å‰å¾€ <a href="https://resend.com/" target="_blank">https://resend.com/</a> è¨»å†Šå…è²»å¸³è™Ÿï¼ˆæ¯æœˆ 3000 å°å…è²»é¡åº¦ï¼‰</p>

                <h6>2. ç²å– API é‡‘é‘°</h6>
                <ol>
                    <li>ç™»å…¥ Resend Dashboard</li>
                    <li>å‰å¾€ API Keys é é¢</li>
                    <li>é»æ“Š "Create API Key"</li>
                    <li>é¸æ“‡ "Sending access" æ¬Šé™</li>
                    <li>è¤‡è£½ç”Ÿæˆçš„ API é‡‘é‘°</li>
                </ol>

                <h6>3. é…ç½® Render ç’°å¢ƒè®Šæ•¸</h6>
                <ol>
                    <li>é€²å…¥ Render Dashboard</li>
                    <li>é¸æ“‡æ‚¨çš„æœå‹™</li>
                    <li>å‰å¾€ Environment é é¢</li>
                    <li>æ·»åŠ ä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼š</li>
                </ol>

                <div class="bg-light p-3 rounded">
                    <code>
                        RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>
                        EMAIL_FROM=noreply@yourdomain.com
                    </code>
                </div>

                <div class="alert alert-info mt-3">
                    <strong>æ³¨æ„ï¼š</strong> EMAIL_FROM å¿…é ˆæ˜¯æ‚¨åœ¨ Resend ä¸­é©—è­‰çš„ç¶²åŸŸæˆ–ä½¿ç”¨ Resend çš„æ¸¬è©¦ç¶²åŸŸ
                </div>

                <h6>4. é‡æ–°éƒ¨ç½²æœå‹™</h6>
                <p>åœ¨ Render Dashboard ä¸­é»æ“Š "Manual Deploy" é‡æ–°éƒ¨ç½²æ‚¨çš„æœå‹™</p>
            `;

            modal.show();
        }

        // æ¸…é™¤æ—¥èªŒ
        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = `
                <div class="log-entry info">
                    <i class="fas fa-info-circle"></i>
                    [æ¸…é™¤] æ—¥èªŒå·²æ¸…é™¤
                </div>
            `;
            logCounter = 0;
        }
    </script>
</body>
</html>