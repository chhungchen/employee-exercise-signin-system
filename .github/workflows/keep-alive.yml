name: Keep Render Service Alive

on:
  schedule:
    # æ¯ 14 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼Œä½†é¿é–‹å°ç£æ™‚é–“ 0-6 é»ï¼ˆUTC 16-22ï¼‰
    # åˆ†æˆå…©å€‹æ™‚é–“æ®µï¼šUTC 23-23 å’Œ 0-15 ï¼ˆå°æ‡‰å°ç£æ™‚é–“ 7-6 é»éš”å¤©ï¼‰
    - cron: '*/14 23 * * *'      # UTC 23:xx (å°ç£ 07:xx)
    - cron: '*/14 0-15 * * *'    # UTC 0-15:xx (å°ç£ 08-23:xx)
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

env:
  TZ: 'Asia/Taipei'

jobs:
  ping-service:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“… æª¢æŸ¥ç•¶å‰æ™‚é–“
      run: |
        echo "Current time: $(TZ=${{ env.TZ }} date '+%Y-%m-%d %H:%M:%S %Z')"
    
    - name: ğŸ“¡ Ping ä¸»è¦æœå‹™
      id: ping_main
      run: |
        echo "æ­£åœ¨ ping ä¸»è¦æœå‹™..."
        
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          --max-time 30 \
          --retry 3 \
          --retry-delay 5 \
          "https://employee-exercise-signin-system.onrender.com/api/health")
        
        echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        
        if [ $HTTP_CODE -eq 200 ]; then
          echo "âœ… ä¸»è¦æœå‹™é‹è¡Œæ­£å¸¸ (HTTP $HTTP_CODE)"
        elif [ $HTTP_CODE -eq 502 ] || [ $HTTP_CODE -eq 503 ]; then
          echo "ğŸ”„ æœå‹™å¯èƒ½æ­£åœ¨é‡å•Ÿä¸­ (HTTP $HTTP_CODE)"
        else
          echo "âš ï¸ æœå‹™è¿”å›ç•°å¸¸ç‹€æ…‹ (HTTP $HTTP_CODE)"
        fi
    
    - name: ğŸ¥ å¥åº·æª¢æŸ¥
      if: steps.ping_main.outputs.http_code == '200'
      continue-on-error: true
      run: |
        echo "åŸ·è¡Œè©³ç´°å¥åº·æª¢æŸ¥..."
        
        HEALTH=$(curl -s --max-time 10 \
          "https://employee-exercise-signin-system.onrender.com/api/health")
        
        echo "å¥åº·æª¢æŸ¥éŸ¿æ‡‰: $HEALTH"
        
        # è§£æ uptime
        UPTIME=$(echo "$HEALTH" | grep -o '"uptime":[0-9.]*' | cut -d':' -f2)
        if [ ! -z "$UPTIME" ]; then
          echo "æœå‹™é‹è¡Œæ™‚é–“: ${UPTIME} ç§’"
        fi
    
    - name: ğŸ“Š è¨˜éŒ„çµæœ
      if: always()
      run: |
        echo "=== Keep-Alive ç›£æ§æ‘˜è¦ ==="
        echo "æœå‹™: Employee Exercise SignIn"
        echo "ç‹€æ…‹ä»£ç¢¼: ${{ steps.ping_main.outputs.http_code }}"
        echo "æ™‚é–“: $(TZ=${{ env.TZ }} date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "GitHub Action: å®šæœŸç›£æ§æˆåŠŸåŸ·è¡Œ"
        echo "========================="
    
    - name: ğŸš¨ å¤±æ•—é€šçŸ¥
      if: steps.ping_main.outputs.http_code != '200' && steps.ping_main.outputs.http_code != '502' && steps.ping_main.outputs.http_code != '503'
      run: |
        echo "ğŸš¨ æœå‹™ç›£æ§è­¦å‘Š"
        echo "HTTP ç‹€æ…‹: ${{ steps.ping_main.outputs.http_code }}"
        echo "é€™å¯èƒ½è¡¨ç¤ºæœå‹™å‡ºç¾å•é¡Œï¼Œå»ºè­°æ‰‹å‹•æª¢æŸ¥"
        # æ³¨æ„ï¼šé€™ä¸æœƒå°è‡´ workflow å¤±æ•—ï¼Œåªæ˜¯è¨˜éŒ„è­¦å‘Š