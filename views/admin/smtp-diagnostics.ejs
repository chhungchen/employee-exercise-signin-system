<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­SMTPè¨ºæ–·å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .diagnostic-step {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        .step-pending { border-left-color: #6c757d; }
        .step-running { border-left-color: #0d6efd; }
        .step-success { border-left-color: #198754; }
        .step-error { border-left-color: #dc3545; }
        .log-viewer {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 4px;
        }
        .config-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 0.3em 0.6em;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-envelope-open-text text-primary"></i> ä¼æ¥­SMTPè¨ºæ–·å·¥å…·</h2>
                    <div>
                        <button id="startDiagnostic" class="btn btn-primary me-2">
                            <i class="fas fa-play"></i> é–‹å§‹è¨ºæ–·
                        </button>
                        <button id="downloadReport" class="btn btn-outline-secondary" disabled>
                            <i class="fas fa-download"></i> ä¸‹è¼‰å ±å‘Š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- è¨ºæ–·é…ç½®å€ -->
            <div class="col-md-4">
                <div class="config-section">
                    <h5><i class="fas fa-cog text-secondary"></i> è¨ºæ–·é…ç½®</h5>
                    <div class="mb-3">
                        <label class="form-label">SMTP ä¸»æ©Ÿ</label>
                        <input type="text" id="smtpHost" class="form-control"
                               value="<%= process.env.INTERNAL_SMTP_HOST || 'internal.company.local' %>">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ç«¯å£</label>
                        <input type="number" id="smtpPort" class="form-control" value="25">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ¸¬è©¦è¶…æ™‚ (æ¯«ç§’)</label>
                        <input type="number" id="timeout" class="form-control" value="5000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é‡è©¦æ¬¡æ•¸</label>
                        <input type="number" id="retries" class="form-control" value="3">
                    </div>
                </div>

                <div class="config-section">
                    <h6><i class="fas fa-info-circle text-info"></i> ç’°å¢ƒè®Šæ•¸ç‹€æ…‹</h6>
                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span>INTERNAL_SMTP_HOST:</span>
                            <span class="badge <%= process.env.INTERNAL_SMTP_HOST ? 'bg-success' : 'bg-warning' %> status-badge">
                                <%= process.env.INTERNAL_SMTP_HOST ? 'å·²è¨­å®š' : 'æœªè¨­å®š' %>
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span>INTERNAL_SMTP_FROM:</span>
                            <span class="badge <%= process.env.INTERNAL_SMTP_FROM ? 'bg-success' : 'bg-warning' %> status-badge">
                                <%= process.env.INTERNAL_SMTP_FROM ? 'å·²è¨­å®š' : 'æœªè¨­å®š' %>
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span>NODE_ENV:</span>
                            <span class="badge bg-info status-badge">
                                <%= process.env.NODE_ENV || 'development' %>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨ºæ–·é€²åº¦å€ -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-tasks"></i> è¨ºæ–·é€²åº¦
                            <span id="overallStatus" class="badge bg-secondary ms-2">æº–å‚™ä¸­</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- è¨ºæ–·æ­¥é©Ÿ -->
                        <div id="step1" class="diagnostic-step step-pending">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-network-wired"></i> æ­¥é©Ÿ1: DNSè§£ææ¸¬è©¦</strong>
                                <span class="badge bg-secondary">ç­‰å¾…ä¸­</span>
                            </div>
                            <div class="text-muted small mt-1">æª¢æŸ¥ä¼æ¥­SMTPä¼ºæœå™¨åŸŸåè§£æ</div>
                            <div id="step1-details" class="mt-2" style="display:none;"></div>
                        </div>

                        <div id="step2" class="diagnostic-step step-pending">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-plug"></i> æ­¥é©Ÿ2: TCPé€£æ¥æ¸¬è©¦</strong>
                                <span class="badge bg-secondary">ç­‰å¾…ä¸­</span>
                            </div>
                            <div class="text-muted small mt-1">æª¢æŸ¥ç«¯å£25çš„TCPé€£æ¥å¯é”æ€§</div>
                            <div id="step2-details" class="mt-2" style="display:none;"></div>
                        </div>

                        <div id="step3" class="diagnostic-step step-pending">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-handshake"></i> æ­¥é©Ÿ3: SMTPæ¡æ‰‹æ¸¬è©¦</strong>
                                <span class="badge bg-secondary">ç­‰å¾…ä¸­</span>
                            </div>
                            <div class="text-muted small mt-1">åŸ·è¡ŒSMTPå”è­°æ¡æ‰‹å’ŒEHLOå‘½ä»¤</div>
                            <div id="step3-details" class="mt-2" style="display:none;"></div>
                        </div>

                        <div id="step4" class="diagnostic-step step-pending">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong><i class="fas fa-envelope"></i> æ­¥é©Ÿ4: æ¸¬è©¦éƒµä»¶ç™¼é€</strong>
                                <span class="badge bg-secondary">ç­‰å¾…ä¸­</span>
                            </div>
                            <div class="text-muted small mt-1">å˜—è©¦ç™¼é€æ¸¬è©¦éƒµä»¶</div>
                            <div id="step4-details" class="mt-2" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <!-- å¯¦æ™‚æ—¥èªŒå€ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-terminal"></i> å¯¦æ™‚è¨ºæ–·æ—¥èªŒ</h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="logViewer" class="log-viewer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let diagnosticData = [];
        let currentStep = 0;

        document.getElementById('startDiagnostic').addEventListener('click', startDiagnostic);
        document.getElementById('downloadReport').addEventListener('click', downloadReport);

        function addLog(message, type = 'info') {
            const logViewer = document.getElementById('logViewer');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'info': '#00ff00',
                'error': '#ff4444',
                'warning': '#ffaa00',
                'success': '#00ff88'
            }[type];

            logViewer.innerHTML += `<div style="color: ${colorClass};">[${timestamp}] ${message}</div>`;
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        function updateStepStatus(step, status, details = '') {
            const stepElement = document.getElementById(`step${step}`);
            const badge = stepElement.querySelector('.badge');
            const detailsElement = document.getElementById(`step${step}-details`);

            stepElement.className = `diagnostic-step step-${status}`;

            const statusMap = {
                'pending': { text: 'ç­‰å¾…ä¸­', class: 'bg-secondary' },
                'running': { text: 'åŸ·è¡Œä¸­', class: 'bg-primary' },
                'success': { text: 'æˆåŠŸ', class: 'bg-success' },
                'error': { text: 'å¤±æ•—', class: 'bg-danger' }
            };

            badge.textContent = statusMap[status].text;
            badge.className = `badge ${statusMap[status].class}`;

            if (details) {
                detailsElement.innerHTML = details;
                detailsElement.style.display = 'block';
            }
        }

        async function startDiagnostic() {
            const startBtn = document.getElementById('startDiagnostic');
            const downloadBtn = document.getElementById('downloadReport');

            startBtn.disabled = true;
            downloadBtn.disabled = true;

            document.getElementById('overallStatus').textContent = 'è¨ºæ–·ä¸­';
            document.getElementById('overallStatus').className = 'badge bg-primary ms-2';

            addLog('ğŸ” é–‹å§‹ä¼æ¥­SMTPè¨ºæ–·æµç¨‹...', 'info');

            const config = {
                host: document.getElementById('smtpHost').value,
                port: parseInt(document.getElementById('smtpPort').value),
                timeout: parseInt(document.getElementById('timeout').value),
                retries: parseInt(document.getElementById('retries').value)
            };

            addLog(`ğŸ“‹ è¨ºæ–·é…ç½®: ${config.host}:${config.port}, è¶…æ™‚:${config.timeout}ms, é‡è©¦:${config.retries}æ¬¡`, 'info');

            try {
                // åŸ·è¡Œæ‰€æœ‰è¨ºæ–·æ­¥é©Ÿ
                await executeDiagnosticSteps(config);

                document.getElementById('overallStatus').textContent = 'è¨ºæ–·å®Œæˆ';
                document.getElementById('overallStatus').className = 'badge bg-success ms-2';
                addLog('âœ… è¨ºæ–·æµç¨‹å®Œæˆï¼', 'success');

                downloadBtn.disabled = false;

            } catch (error) {
                document.getElementById('overallStatus').textContent = 'è¨ºæ–·å¤±æ•—';
                document.getElementById('overallStatus').className = 'badge bg-danger ms-2';
                addLog(`âŒ è¨ºæ–·éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }

            startBtn.disabled = false;
        }

        async function executeDiagnosticSteps(config) {
            const steps = [
                { name: 'DNSè§£ææ¸¬è©¦', endpoint: '/admin/smtp-diagnostics/dns' },
                { name: 'TCPé€£æ¥æ¸¬è©¦', endpoint: '/admin/smtp-diagnostics/tcp' },
                { name: 'SMTPæ¡æ‰‹æ¸¬è©¦', endpoint: '/admin/smtp-diagnostics/smtp' },
                { name: 'æ¸¬è©¦éƒµä»¶ç™¼é€', endpoint: '/admin/smtp-diagnostics/send' }
            ];

            for (let i = 0; i < steps.length; i++) {
                const stepNum = i + 1;
                const step = steps[i];

                updateStepStatus(stepNum, 'running');
                addLog(`ğŸ”„ åŸ·è¡Œ ${step.name}...`, 'info');

                try {
                    const response = await fetch(step.endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    const result = await response.json();
                    diagnosticData.push({ step: stepNum, name: step.name, ...result });

                    if (result.success) {
                        updateStepStatus(stepNum, 'success', `<div class="small text-success">${result.message}</div>`);
                        addLog(`âœ… ${step.name} æˆåŠŸ: ${result.message}`, 'success');
                    } else {
                        updateStepStatus(stepNum, 'error', `<div class="small text-danger">${result.error}</div>`);
                        addLog(`âŒ ${step.name} å¤±æ•—: ${result.error}`, 'error');
                    }

                    if (result.details) {
                        addLog(`ğŸ“Š è©³ç´°ä¿¡æ¯: ${JSON.stringify(result.details)}`, 'info');
                    }

                } catch (error) {
                    updateStepStatus(stepNum, 'error', `<div class="small text-danger">ç¶²è·¯è«‹æ±‚å¤±æ•—: ${error.message}</div>`);
                    addLog(`âŒ ${step.name} åŸ·è¡Œå¤±æ•—: ${error.message}`, 'error');
                }

                // çŸ­æš«å»¶é²
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        function downloadReport() {
            const report = {
                timestamp: new Date().toISOString(),
                environment: {
                    nodeEnv: '<%= process.env.NODE_ENV || "development" %>',
                    internalSmtpHost: '<%= process.env.INTERNAL_SMTP_HOST ? "å·²è¨­å®š" : "æœªè¨­å®š" %>',
                    internalSmtpFrom: '<%= process.env.INTERNAL_SMTP_FROM ? "å·²è¨­å®š" : "æœªè¨­å®š" %>'
                },
                configuration: {
                    host: document.getElementById('smtpHost').value,
                    port: document.getElementById('smtpPort').value,
                    timeout: document.getElementById('timeout').value,
                    retries: document.getElementById('retries').value
                },
                results: diagnosticData,
                logs: document.getElementById('logViewer').innerText
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smtp-diagnostic-report-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // é é¢è¼‰å…¥æ™‚æ·»åŠ åˆå§‹æ—¥èªŒ
        window.addEventListener('load', () => {
            addLog('ğŸš€ ä¼æ¥­SMTPè¨ºæ–·å·¥å…·å·²å°±ç·’', 'info');
            addLog('ğŸ’¡ è«‹é»æ“Š"é–‹å§‹è¨ºæ–·"æŒ‰éˆ•é–‹å§‹æ¸¬è©¦', 'info');
        });
    </script>
</body>
</html>