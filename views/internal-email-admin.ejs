<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .header-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .config-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #007bff;
        }
        .status-badge {
            font-size: 0.85em;
            padding: 0.4em 0.8em;
        }
        .progress-container {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log-viewer {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 6px;
            margin-top: 1rem;
        }
        .quick-action-btn {
            font-size: 1.1em;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
        }
        .form-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .recipients-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- æ¨™é¡Œå€ -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-server"></i> <%= title %></h1>
                    <p class="mb-0">ä¼æ¥­å…§ç¶²å°ˆç”¨ | é«˜é€ŸSMTPè£œç™¼ | ç•¶å‰æ™‚é–“: <%= currentTime %></p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-success status-badge mb-2">
                            <i class="fas fa-check-circle"></i> å…§ç¶²æ¨¡å¼
                        </span>
                        <small>SMTP: <%= smtpHost %></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ç³»çµ±ç‹€æ…‹å€ -->
        <div class="row">
            <div class="col-md-6">
                <div class="config-card">
                    <h5><i class="fas fa-info-circle text-primary"></i> ç³»çµ±è³‡è¨Š</h5>
                    <div class="row">
                        <div class="col-6">
                            <strong>SMTPä¸»æ©Ÿ:</strong><br>
                            <code><%= smtpHost %></code>
                        </div>
                        <div class="col-6">
                            <strong>ç™¼ä»¶äºº:</strong><br>
                            <code><%= smtpFrom %></code>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button id="checkStatusBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync"></i> æª¢æŸ¥ç³»çµ±ç‹€æ…‹
                        </button>
                        <button id="testSmtpBtn" class="btn btn-outline-success btn-sm ms-2">
                            <i class="fas fa-paper-plane"></i> æ¸¬è©¦SMTP
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="config-card">
                    <h5><i class="fas fa-chart-line text-success"></i> å³æ™‚ç‹€æ…‹</h5>
                    <div id="systemStatus">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            <span>è¼‰å…¥ç³»çµ±ç‹€æ…‹ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰‹å‹•è£œç™¼å€ -->
        <div class="form-section">
            <h4><i class="fas fa-envelope-open-text text-primary"></i> æ‰‹å‹•éƒµä»¶è£œç™¼</h4>
            <p class="text-muted">é¸æ“‡æ—¥æœŸç¯„åœå’Œæ”¶ä»¶äººï¼Œæ‰‹å‹•è£œç™¼éºæ¼çš„å®šæœŸå ±å‘Š</p>

            <form id="manualSendForm">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">å ±å‘Šæ ¼å¼</label>
                        <select id="reportFormat" class="form-control">
                            <option value="excel">Excelæ ¼å¼</option>
                            <option value="pdf">PDFæ ¼å¼</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">åŒ…å«ç…§ç‰‡</label>
                        <div class="form-check mt-2">
                            <input type="checkbox" id="includePhotos" class="form-check-input">
                            <label class="form-check-label">åŒ…å«ç°½åˆ°ç…§ç‰‡</label>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">æ”¶ä»¶äººé¸æ“‡</label>
                        <div class="recipients-list" id="recipientsList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> è¼‰å…¥æ”¶ä»¶äººæ¸…å–®...
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" id="selectAllBtn" class="btn btn-outline-secondary btn-sm">å…¨é¸</button>
                            <button type="button" id="selectNoneBtn" class="btn btn-outline-secondary btn-sm ms-1">å…¨ä¸é¸</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">å¿«é€Ÿæ“ä½œ</label>
                        <div class="d-grid gap-2">
                            <button type="button" id="loadDateRangeBtn" class="btn btn-info">
                                <i class="fas fa-calendar-alt"></i> è¼‰å…¥å¯ç”¨æ—¥æœŸç¯„åœ
                            </button>
                            <button type="button" id="previewBtn" class="btn btn-warning">
                                <i class="fas fa-eye"></i> é è¦½è³‡æ–™ç¯„åœ
                            </button>
                            <button type="submit" id="sendBtn" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> é–‹å§‹è£œç™¼éƒµä»¶
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- é€²åº¦é¡¯ç¤ºå€ -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <h5><i class="fas fa-tasks"></i> è£œç™¼é€²åº¦</h5>
            <div class="progress mb-3">
                <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <div id="progressText">æº–å‚™ä¸­...</div>
            <div id="progressDetails" class="mt-2"></div>
        </div>

        <!-- å³æ™‚æ—¥èªŒå€ -->
        <div class="form-section">
            <h5><i class="fas fa-terminal"></i> å³æ™‚æ—¥èªŒ
                <button id="clearLogBtn" class="btn btn-outline-secondary btn-sm float-end">
                    <i class="fas fa-trash"></i> æ¸…é™¤æ—¥èªŒ
                </button>
            </h5>
            <div id="logViewer" class="log-viewer"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let recipientsList = [];
        let sendInProgress = false;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸš€ å…§ç¶²è¼”åŠ©éƒµä»¶ä¼ºæœå™¨ç®¡ç†ä»‹é¢å·²è¼‰å…¥', 'info');
            loadSystemStatus();
            loadRecipients();
            setDefaultDates();
        });

        // è¨­å®šé è¨­æ—¥æœŸï¼ˆæœ€è¿‘7å¤©ï¼‰
        function setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        }

        // è¼‰å…¥ç³»çµ±ç‹€æ…‹
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/internal/status');
                const data = await response.json();

                if (data.success) {
                    const status = data.status;
                    document.getElementById('systemStatus').innerHTML = `
                        <div class="row small">
                            <div class="col-6">
                                <strong>é‹è¡Œæ™‚é–“:</strong><br>
                                ${Math.floor(status.server.uptime / 60)} åˆ†é˜
                            </div>
                            <div class="col-6">
                                <strong>è¨˜æ†¶é«”ä½¿ç”¨:</strong><br>
                                ${Math.round(status.server.memory.rss / 1024 / 1024)} MB
                            </div>
                            <div class="col-6 mt-2">
                                <strong>éƒµä»¶æœå‹™:</strong><br>
                                <span class="badge bg-${status.services.emailService === 'loaded' ? 'success' : 'danger'}">
                                    ${status.services.emailService}
                                </span>
                            </div>
                            <div class="col-6 mt-2">
                                <strong>Googleæœå‹™:</strong><br>
                                <span class="badge bg-${status.services.googleServices === 'loaded' ? 'success' : 'warning'}">
                                    ${status.services.googleServices}
                                </span>
                            </div>
                        </div>
                    `;
                    addLog('âœ… ç³»çµ±ç‹€æ…‹è¼‰å…¥æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i> ç‹€æ…‹è¼‰å…¥å¤±æ•—: ${error.message}
                    </div>
                `;
                addLog(`âŒ ç³»çµ±ç‹€æ…‹è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // è¼‰å…¥æ”¶ä»¶äººæ¸…å–®
        async function loadRecipients() {
            try {
                const response = await fetch('/api/internal/recipients');
                const data = await response.json();

                if (data.success) {
                    recipientsList = data.recipients;
                    renderRecipients();
                    addLog(`âœ… è¼‰å…¥ ${recipientsList.length} å€‹æ”¶ä»¶äºº`, 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('recipientsList').innerHTML = `
                    <div class="text-danger text-center">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        è¼‰å…¥æ”¶ä»¶äººå¤±æ•—: ${error.message}
                    </div>
                `;
                addLog(`âŒ è¼‰å…¥æ”¶ä»¶äººå¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ¸²æŸ“æ”¶ä»¶äººæ¸…å–®
        function renderRecipients() {
            const container = document.getElementById('recipientsList');
            container.innerHTML = recipientsList.map((email, index) => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${email}" id="recipient${index}" checked>
                    <label class="form-check-label" for="recipient${index}">
                        ${email}
                    </label>
                </div>
            `).join('');
        }

        // å…¨é¸/å…¨ä¸é¸
        document.getElementById('selectAllBtn').addEventListener('click', function() {
            document.querySelectorAll('#recipientsList input[type="checkbox"]').forEach(cb => cb.checked = true);
        });

        document.getElementById('selectNoneBtn').addEventListener('click', function() {
            document.querySelectorAll('#recipientsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        });

        // è¼‰å…¥æ—¥æœŸç¯„åœ
        document.getElementById('loadDateRangeBtn').addEventListener('click', async function() {
            try {
                addLog('ğŸ“… è¼‰å…¥å¯ç”¨æ—¥æœŸç¯„åœ...', 'info');
                const response = await fetch('/api/internal/date-range');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('startDate').value = data.dateRange.start;
                    document.getElementById('endDate').value = data.dateRange.end;
                    addLog(`âœ… æ—¥æœŸç¯„åœ: ${data.dateRange.start} è‡³ ${data.dateRange.end} (${data.dateRange.totalDays}å¤©)`, 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                addLog(`âŒ è¼‰å…¥æ—¥æœŸç¯„åœå¤±æ•—: ${error.message}`, 'error');
            }
        });

        // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        document.getElementById('checkStatusBtn').addEventListener('click', loadSystemStatus);

        // æ¸¬è©¦SMTP
        document.getElementById('testSmtpBtn').addEventListener('click', async function() {
            try {
                addLog('ğŸ“§ æ¸¬è©¦ä¼æ¥­SMTPé€£æ¥...', 'info');
                // é€™è£¡å¯ä»¥æ·»åŠ SMTPæ¸¬è©¦é‚è¼¯
                addLog('âœ… SMTPæ¸¬è©¦ - åŠŸèƒ½é–‹ç™¼ä¸­', 'warning');
            } catch (error) {
                addLog(`âŒ SMTPæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        });

        // æ‰‹å‹•è£œç™¼è¡¨å–®æäº¤
        document.getElementById('manualSendForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (sendInProgress) {
                addLog('âš ï¸ å·²æœ‰è£œç™¼ä½œæ¥­é€²è¡Œä¸­ï¼Œè«‹ç¨å€™', 'warning');
                return;
            }

            const formData = getFormData();
            if (!validateFormData(formData)) return;

            sendInProgress = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';

            try {
                addLog(`ğŸ“§ é–‹å§‹è£œç™¼: ${formData.startDate} è‡³ ${formData.endDate}`, 'info');
                addLog(`ğŸ“¬ æ”¶ä»¶äºº: ${formData.recipients.length} äºº`, 'info');

                const response = await fetch('/api/internal/send-manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    updateProgress(100, `è£œç™¼å®Œæˆ: ${result.details.successCount}/${result.details.totalRecipients} æˆåŠŸ`);
                    addLog(`âœ… ${result.message}`, 'success');
                    addLog(`ğŸ“Š è³‡æ–™ç­†æ•¸: ${result.details.recordCount}`, 'info');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                updateProgress(0, 'è£œç™¼å¤±æ•—');
                addLog(`âŒ è£œç™¼å¤±æ•—: ${error.message}`, 'error');
            } finally {
                sendInProgress = false;
                document.getElementById('sendBtn').disabled = false;
            }
        });

        // å–å¾—è¡¨å–®è³‡æ–™
        function getFormData() {
            const selectedRecipients = Array.from(document.querySelectorAll('#recipientsList input[type="checkbox"]:checked'))
                                           .map(cb => cb.value);

            return {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                recipients: selectedRecipients,
                format: document.getElementById('reportFormat').value,
                includePhotos: document.getElementById('includePhotos').checked
            };
        }

        // é©—è­‰è¡¨å–®è³‡æ–™
        function validateFormData(data) {
            if (!data.startDate || !data.endDate) {
                addLog('âŒ è«‹é¸æ“‡æ—¥æœŸç¯„åœ', 'error');
                return false;
            }

            if (data.recipients.length === 0) {
                addLog('âŒ è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ”¶ä»¶äºº', 'error');
                return false;
            }

            if (new Date(data.startDate) > new Date(data.endDate)) {
                addLog('âŒ é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ', 'error');
                return false;
            }

            return true;
        }

        // æ›´æ–°é€²åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ¸…é™¤æ—¥èªŒ
        document.getElementById('clearLogBtn').addEventListener('click', function() {
            document.getElementById('logViewer').innerHTML = '';
            addLog('ğŸ§¹ æ—¥èªŒå·²æ¸…é™¤', 'info');
        });

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const logViewer = document.getElementById('logViewer');
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#00ff00',
                'success': '#00ff88',
                'warning': '#ffaa00',
                'error': '#ff4444'
            };

            logViewer.innerHTML += `<div style="color: ${colorMap[type]};">[${timestamp}] ${message}</div>`;
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        // é é¢è¼‰å…¥å®Œæˆæ—¥èªŒ
        addLog('ğŸ  å…§ç¶²è¼”åŠ©éƒµä»¶ä¼ºæœå™¨ç®¡ç†ä»‹é¢å°±ç·’', 'success');
    </script>
</body>
</html>