<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .header-section {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .config-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #007bff;
        }
        .status-badge {
            font-size: 0.85em;
            padding: 0.4em 0.8em;
        }
        .progress-container {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log-viewer {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 6px;
            margin-top: 1rem;
        }
        .quick-action-btn {
            font-size: 1.1em;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
        }
        .form-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .recipients-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- 標題區 -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-server"></i> <%= title %></h1>
                    <p class="mb-0">企業內網專用 | 高速SMTP補發 | 當前時間: <%= currentTime %></p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-success status-badge mb-2">
                            <i class="fas fa-check-circle"></i> 內網模式
                        </span>
                        <small>SMTP: <%= smtpHost %></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 系統狀態區 -->
        <div class="row">
            <div class="col-md-6">
                <div class="config-card">
                    <h5><i class="fas fa-info-circle text-primary"></i> 系統資訊</h5>
                    <div class="row">
                        <div class="col-6">
                            <strong>SMTP主機:</strong><br>
                            <code><%= smtpHost %></code>
                        </div>
                        <div class="col-6">
                            <strong>發件人:</strong><br>
                            <code><%= smtpFrom %></code>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button id="checkStatusBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync"></i> 檢查系統狀態
                        </button>
                        <button id="testSmtpBtn" class="btn btn-outline-success btn-sm ms-2">
                            <i class="fas fa-paper-plane"></i> 測試SMTP
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="config-card">
                    <h5><i class="fas fa-chart-line text-success"></i> 即時狀態</h5>
                    <div id="systemStatus">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            <span>載入系統狀態中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 手動補發區 -->
        <div class="form-section">
            <h4><i class="fas fa-envelope-open-text text-primary"></i> 手動郵件補發</h4>
            <p class="text-muted">選擇日期範圍和收件人，手動補發遺漏的定期報告</p>

            <form id="manualSendForm">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">開始日期</label>
                        <input type="date" id="startDate" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">結束日期</label>
                        <input type="date" id="endDate" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">報告格式</label>
                        <select id="reportFormat" class="form-control">
                            <option value="excel">Excel格式</option>
                            <option value="pdf">PDF格式</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">包含照片</label>
                        <div class="form-check mt-2">
                            <input type="checkbox" id="includePhotos" class="form-check-input">
                            <label class="form-check-label">包含簽到照片</label>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">收件人選擇</label>
                        <div class="recipients-list" id="recipientsList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> 載入收件人清單...
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" id="selectAllBtn" class="btn btn-outline-secondary btn-sm">全選</button>
                            <button type="button" id="selectNoneBtn" class="btn btn-outline-secondary btn-sm ms-1">全不選</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">快速操作</label>
                        <div class="d-grid gap-2">
                            <button type="button" id="loadDateRangeBtn" class="btn btn-info">
                                <i class="fas fa-calendar-alt"></i> 載入可用日期範圍
                            </button>
                            <button type="button" id="previewBtn" class="btn btn-warning">
                                <i class="fas fa-eye"></i> 預覽資料範圍
                            </button>
                            <button type="submit" id="sendBtn" class="btn btn-success">
                                <i class="fas fa-paper-plane"></i> 開始補發郵件
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- 進度顯示區 -->
        <div class="progress-container" id="progressContainer" style="display: none;">
            <h5><i class="fas fa-tasks"></i> 補發進度</h5>
            <div class="progress mb-3">
                <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <div id="progressText">準備中...</div>
            <div id="progressDetails" class="mt-2"></div>
        </div>

        <!-- 即時日誌區 -->
        <div class="form-section">
            <h5><i class="fas fa-terminal"></i> 即時日誌
                <button id="clearLogBtn" class="btn btn-outline-secondary btn-sm float-end">
                    <i class="fas fa-trash"></i> 清除日誌
                </button>
            </h5>
            <div id="logViewer" class="log-viewer"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let recipientsList = [];
        let sendInProgress = false;

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLog('🚀 內網輔助郵件伺服器管理介面已載入', 'info');
            loadSystemStatus();
            loadRecipients();
            setDefaultDates();
        });

        // 設定預設日期（最近7天）
        function setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        }

        // 載入系統狀態
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/internal/status');
                const data = await response.json();

                if (data.success) {
                    const status = data.status;
                    document.getElementById('systemStatus').innerHTML = `
                        <div class="row small">
                            <div class="col-6">
                                <strong>運行時間:</strong><br>
                                ${Math.floor(status.server.uptime / 60)} 分鐘
                            </div>
                            <div class="col-6">
                                <strong>記憶體使用:</strong><br>
                                ${Math.round(status.server.memory.rss / 1024 / 1024)} MB
                            </div>
                            <div class="col-6 mt-2">
                                <strong>郵件服務:</strong><br>
                                <span class="badge bg-${status.services.emailService === 'loaded' ? 'success' : 'danger'}">
                                    ${status.services.emailService}
                                </span>
                            </div>
                            <div class="col-6 mt-2">
                                <strong>Google服務:</strong><br>
                                <span class="badge bg-${status.services.googleServices === 'loaded' ? 'success' : 'warning'}">
                                    ${status.services.googleServices}
                                </span>
                            </div>
                        </div>
                    `;
                    addLog('✅ 系統狀態載入成功', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i> 狀態載入失敗: ${error.message}
                    </div>
                `;
                addLog(`❌ 系統狀態載入失敗: ${error.message}`, 'error');
            }
        }

        // 載入收件人清單
        async function loadRecipients() {
            try {
                const response = await fetch('/api/internal/recipients');
                const data = await response.json();

                if (data.success) {
                    recipientsList = data.recipients;
                    renderRecipients();
                    addLog(`✅ 載入 ${recipientsList.length} 個收件人`, 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('recipientsList').innerHTML = `
                    <div class="text-danger text-center">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        載入收件人失敗: ${error.message}
                    </div>
                `;
                addLog(`❌ 載入收件人失敗: ${error.message}`, 'error');
            }
        }

        // 渲染收件人清單
        function renderRecipients() {
            const container = document.getElementById('recipientsList');
            container.innerHTML = recipientsList.map((email, index) => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${email}" id="recipient${index}" checked>
                    <label class="form-check-label" for="recipient${index}">
                        ${email}
                    </label>
                </div>
            `).join('');
        }

        // 全選/全不選
        document.getElementById('selectAllBtn').addEventListener('click', function() {
            document.querySelectorAll('#recipientsList input[type="checkbox"]').forEach(cb => cb.checked = true);
        });

        document.getElementById('selectNoneBtn').addEventListener('click', function() {
            document.querySelectorAll('#recipientsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        });

        // 載入日期範圍
        document.getElementById('loadDateRangeBtn').addEventListener('click', async function() {
            try {
                addLog('📅 載入可用日期範圍...', 'info');
                const response = await fetch('/api/internal/date-range');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('startDate').value = data.dateRange.start;
                    document.getElementById('endDate').value = data.dateRange.end;
                    addLog(`✅ 日期範圍: ${data.dateRange.start} 至 ${data.dateRange.end} (${data.dateRange.totalDays}天)`, 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                addLog(`❌ 載入日期範圍失敗: ${error.message}`, 'error');
            }
        });

        // 檢查系統狀態
        document.getElementById('checkStatusBtn').addEventListener('click', loadSystemStatus);

        // 測試SMTP
        document.getElementById('testSmtpBtn').addEventListener('click', async function() {
            try {
                addLog('📧 測試企業SMTP連接...', 'info');
                // 這裡可以添加SMTP測試邏輯
                addLog('✅ SMTP測試 - 功能開發中', 'warning');
            } catch (error) {
                addLog(`❌ SMTP測試失敗: ${error.message}`, 'error');
            }
        });

        // 手動補發表單提交
        document.getElementById('manualSendForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (sendInProgress) {
                addLog('⚠️ 已有補發作業進行中，請稍候', 'warning');
                return;
            }

            const formData = getFormData();
            if (!validateFormData(formData)) return;

            sendInProgress = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';

            try {
                addLog(`📧 開始補發: ${formData.startDate} 至 ${formData.endDate}`, 'info');
                addLog(`📬 收件人: ${formData.recipients.length} 人`, 'info');

                const response = await fetch('/api/internal/send-manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    updateProgress(100, `補發完成: ${result.details.successCount}/${result.details.totalRecipients} 成功`);
                    addLog(`✅ ${result.message}`, 'success');
                    addLog(`📊 資料筆數: ${result.details.recordCount}`, 'info');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                updateProgress(0, '補發失敗');
                addLog(`❌ 補發失敗: ${error.message}`, 'error');
            } finally {
                sendInProgress = false;
                document.getElementById('sendBtn').disabled = false;
            }
        });

        // 取得表單資料
        function getFormData() {
            const selectedRecipients = Array.from(document.querySelectorAll('#recipientsList input[type="checkbox"]:checked'))
                                           .map(cb => cb.value);

            return {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                recipients: selectedRecipients,
                format: document.getElementById('reportFormat').value,
                includePhotos: document.getElementById('includePhotos').checked
            };
        }

        // 驗證表單資料
        function validateFormData(data) {
            if (!data.startDate || !data.endDate) {
                addLog('❌ 請選擇日期範圍', 'error');
                return false;
            }

            if (data.recipients.length === 0) {
                addLog('❌ 請選擇至少一個收件人', 'error');
                return false;
            }

            if (new Date(data.startDate) > new Date(data.endDate)) {
                addLog('❌ 開始日期不能晚於結束日期', 'error');
                return false;
            }

            return true;
        }

        // 更新進度
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // 清除日誌
        document.getElementById('clearLogBtn').addEventListener('click', function() {
            document.getElementById('logViewer').innerHTML = '';
            addLog('🧹 日誌已清除', 'info');
        });

        // 添加日誌
        function addLog(message, type = 'info') {
            const logViewer = document.getElementById('logViewer');
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#00ff00',
                'success': '#00ff88',
                'warning': '#ffaa00',
                'error': '#ff4444'
            };

            logViewer.innerHTML += `<div style="color: ${colorMap[type]};">[${timestamp}] ${message}</div>`;
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        // 頁面載入完成日誌
        addLog('🏠 內網輔助郵件伺服器管理介面就緒', 'success');
    </script>
</body>
</html>